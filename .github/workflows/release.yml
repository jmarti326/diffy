name: Release

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.gitignore'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            artifact: Diffy-windows-x64
            extension: .exe
          - os: ubuntu-latest
            rid: linux-x64
            artifact: Diffy-linux-x64
            extension: ''
          - os: macos-latest
            rid: osx-x64
            artifact: Diffy-macos-x64
            extension: ''
          - os: macos-latest
            rid: osx-arm64
            artifact: Diffy-macos-arm64
            extension: ''

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore src/Diffy/Diffy.csproj

      - name: Publish
        run: |
          dotnet publish src/Diffy/Diffy.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:EnableCompressionInSingleFile=true \
            -o ./publish

      - name: Rename artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          mv ./publish/Diffy${{ matrix.extension }} ./publish/${{ matrix.artifact }}${{ matrix.extension }}

      - name: Rename artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Move-Item ./publish/Diffy${{ matrix.extension }} ./publish/${{ matrix.artifact }}${{ matrix.extension }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ./publish/${{ matrix.artifact }}${{ matrix.extension }}
          retention-days: 5

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate version
        id: version
        run: |
          VERSION="v1.0.$(date +'%Y%m%d')-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare release files
        run: |
          mkdir -p release
          # Windows
          cp artifacts/Diffy-windows-x64/Diffy-windows-x64.exe release/
          # Linux
          cp artifacts/Diffy-linux-x64/Diffy-linux-x64 release/
          chmod +x release/Diffy-linux-x64
          # macOS x64
          cp artifacts/Diffy-macos-x64/Diffy-macos-x64 release/
          chmod +x release/Diffy-macos-x64
          # macOS ARM64
          cp artifacts/Diffy-macos-arm64/Diffy-macos-arm64 release/
          chmod +x release/Diffy-macos-arm64

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Diffy ${{ steps.version.outputs.version }}
          body: |
            ## Diffy Release ${{ steps.version.outputs.version }}

            ### Downloads
            - **Windows (x64)**: `Diffy-windows-x64.exe`
            - **Linux (x64)**: `Diffy-linux-x64`
            - **macOS (Intel)**: `Diffy-macos-x64`
            - **macOS (Apple Silicon)**: `Diffy-macos-arm64`

            ### Installation
            1. Download the appropriate file for your operating system
            2. **Windows**: Run the `.exe` file directly
            3. **Linux/macOS**: Make executable with `chmod +x Diffy-*` then run it

            ### Changes
            See commit history for changes in this release.
          files: |
            release/Diffy-windows-x64.exe
            release/Diffy-linux-x64
            release/Diffy-macos-x64
            release/Diffy-macos-arm64
          draft: false
          prerelease: false
